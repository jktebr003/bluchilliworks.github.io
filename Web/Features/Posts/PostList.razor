@page "/posts"

@using MudBlazor
@using global::Shared.Models
@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Web.Services

@inject IState<PostsState> PostsState
@inject IDispatcher Dispatcher
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@inherits FluxorComponent

<div class="div-page-content">
    <span class="heading-meta">Blog</span>
    <MudText Typo="Typo.h4" GutterBottom="true" class="ttl-heading">Latest Posts</MudText>

    <div class="posts-container">
        <!-- Loading State -->
        @if (PostsState.Value.IsLoading)
        {
            <div class="text-center py-5">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
                <MudText Typo="Typo.body1" Class="mt-3">Loading posts...</MudText>
            </div>
        }
        else if (PostsState.Value.ErrorMessage != null)
        {
            <MudAlert Severity="MudBlazor.Severity.Error" Class="mb-4">
                @PostsState.Value.ErrorMessage
            </MudAlert>
        }
        else if (PostsState.Value.Posts == null || !PostsState.Value.Posts.Any())
        {
            <MudAlert Severity="MudBlazor.Severity.Info">
                No posts found.
            </MudAlert>
        }
        else
        {
            <!-- Posts Card Grid -->
            <div class="posts-grid">
                @foreach (var post in PostsState.Value.Posts)
                {
                    <MudCard Class="post-card" Elevation="2">
                        <MudCardContent>
                            <!-- Title -->
                            <MudText Typo="Typo.h5" Class="post-title">@post.Title</MudText>
                            
                            <!-- Category -->
                            @if (!string.IsNullOrEmpty(post.Category))
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="mt-2">
                                    @post.Category
                                </MudChip>
                            }
                            
                            <!-- Description -->
                            @if (!string.IsNullOrEmpty(post.Description))
                            {
                                <MudText Typo="Typo.body2" Class="mt-3 post-description">
                                    @post.Description
                                </MudText>
                            }
                            
                            <MudDivider Class="my-3" />
                            
                            <!-- Post Stats -->
                            <div class="post-stats">
                                <!-- Comments -->
                                <div class="stat-item">
                                    <MudIcon Icon="@Icons.Material.Filled.Comment" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">@(post.TotalComments ?? 0)</MudText>
                                </div>
                                
                                <!-- Likes -->
                                <div class="stat-item">
                                    <MudIcon Icon="@Icons.Material.Filled.ThumbUp" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">@(post.TotalLikes ?? 0)</MudText>
                                </div>
                                
                                <!-- Views -->
                                <div class="stat-item">
                                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                                    <MudText Typo="Typo.body2">@(post.TotalViews ?? 0)</MudText>
                                </div>
                                
                                <!-- Date Posted -->
                                @if (!string.IsNullOrEmpty(post.PostedOn))
                                {
                                    <div class="stat-item">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" />
                                        <MudText Typo="Typo.body2">@FormatDate(post.PostedOn)</MudText>
                                    </div>
                                }
                            </div>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Text" 
                                      Color="Color.Primary" 
                                      Size="Size.Small"
                                      OnClick="@(() => ViewPostDetails(post))">
                                Read More
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                }
            </div>

            <!-- Pagination -->
            @if (PostsState.Value.TotalPages > 1)
            {
                <div class="pagination-container mt-4">
                    <MudPagination Count="@PostsState.Value.TotalPages" 
                                  Selected="@PostsState.Value.CurrentPage" 
                                  SelectedChanged="@OnPageChanged"
                                  Color="Color.Primary"
                                  Variant="Variant.Filled"
                                  ShowFirstButton="true"
                                  ShowLastButton="true" />
                </div>
            }
        }
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
        Dispatcher.Dispatch(new LoadPostsAction(1, 12)); // Load first page with 12 posts
    }

    private void OnPageChanged(int newPage)
    {
        Dispatcher.Dispatch(new ChangePageAction(newPage));
    }

    private void ViewPostDetails(PostResponse post)
    {
        // Navigate to post details page (you can implement this later)
        if (!string.IsNullOrEmpty(post.ID))
        {
            NavigationManager.NavigateTo($"/posts/{post.ID}");
        }
    }

    private string FormatDate(string? dateString)
    {
        if (string.IsNullOrEmpty(dateString))
            return "Unknown";

        if (DateTime.TryParse(dateString, out var date))
        {
            return date.ToString("MMM dd, yyyy");
        }

        return dateString;
    }
}

<style>
    .posts-container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
    }

    .posts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 24px;
        margin-top: 24px;
    }

    .post-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .post-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }

    .post-title {
        font-weight: 600;
        color: var(--mud-palette-text-primary);
        min-height: 60px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .post-description {
        color: var(--mud-palette-text-secondary);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 60px;
    }

    .post-stats {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 6px;
        color: var(--mud-palette-text-secondary);
    }

    .stat-item .mud-icon-root {
        color: var(--mud-palette-primary);
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 32px;
    }

    @@media (max-width: 768px) {
        .posts-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .post-stats {
            gap: 12px;
            font-size: 0.875rem;
        }
    }
</style>
